<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Risk meter - szöveges feliratok</title>
  <style>
    :root { --max-width: 760px; }
    body {
      font-family: Inter, system-ui, "Segoe UI", Roboto, Arial;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; gap: 12px; align-items: center;
      background: #f6f7f9;
    }
    .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .controls input[type="number"], .controls input[type="text"] {
      padding:8px 10px; border-radius:8px; border:1px solid #d0d5dd;
      font-size:14px; min-width:120px;
    }
    .controls button {
      padding:8px 12px; border-radius:8px; border:none; background:#2f80ed;
      color:white; cursor:pointer; font-weight:600;
    }
    .controls button.secondary { background:#6b7280; }
    .meter-wrap {
      width:min(92vw,var(--max-width)); aspect-ratio:2/1;
      background-image:url("meter.png"); background-repeat:no-repeat;
      background-position:center bottom; background-size:contain;
      position:relative; border-radius:8px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
    }
    .label {
      position:absolute; transform:translate(-50%,-50%);
      font-size:14px; font-weight:700; padding:4px 8px; border-radius:6px;
      background:rgba(255,255,255,0.85);
      box-shadow:0 2px 8px rgba(16,24,40,0.08);
      white-space:nowrap; cursor:default;
    }
    .label small { display:block; font-weight:600; font-size:12px; opacity:.9; }
    .list {
      width:min(92vw,var(--max-width)); max-width:var(--max-width);
      background:white; border-radius:8px; padding:8px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
      display:grid; gap:6px;
    }
    .item { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .item > .meta { font-weight:600; }
    .item button { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
    .item button.edit { background:#f59e0b; color:white; }
    .item button.del { background:#ef4444; color:white; }
  </style>
</head>
<body>

  <div class="controls">
    <input id="valueInput" type="number" min="1" max="100" placeholder="Érték (1-100)" />
    <input id="textInput" type="text" placeholder="Felirat" />
    <button id="addBtn">Hozzáadás</button>
    <button id="clearBtn" class="secondary">Összes törlése</button>
  </div>

  <div class="meter-wrap" id="meter"></div>

  <div class="list" id="labelsList"></div>

<!-- FIREBASE INIT -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8Bv0tvQmUUQqluY0J0DEL2ZKTFgibWE8",
    authDomain: "risk-183e9.firebaseapp.com",
    projectId: "risk-183e9",
    storageBucket: "risk-183e9.firebasestorage.app",
    messagingSenderId: "63059763527",
    appId: "1:63059763527:web:6272d43b2eee843d8aac62",
    measurementId: "G-3PCRC8XJJL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------- APP LOGIKA ----------------
  let labels = [];
  const meter = document.getElementById("meter");
  const addBtn = document.getElementById("addBtn");
  const clearBtn = document.getElementById("clearBtn");
  const valueInput = document.getElementById("valueInput");
  const textInput = document.getElementById("textInput");
  const labelsList = document.getElementById("labelsList");
  const colRef = collection(db, "labels");

  function valueToAngleRad(v) {
    let val = Number(v); if (!isFinite(val)) val = 1;
    if (val<1) val=1; if (val>100) val=100;
    return Math.PI * (1 - (val - 1)/99);
  }
  function computePosForValue(v, offset=12) {
    const rect = meter.getBoundingClientRect();
    const w=rect.width, h=rect.height, cx=w/2, cy=h;
    const r = Math.min(w/2,h);
    const theta=valueToAngleRad(v);
    const x=cx+r*Math.cos(theta), y=cy-r*Math.sin(theta);
    return { left: x+offset*Math.cos(theta), top: y-offset*Math.sin(theta) };
  }
  function createLabelDom(obj) {
    const d=document.createElement("div");
    d.className="label"; d.dataset.id=obj.id; d.innerHTML=obj.text;
    d.addEventListener("dblclick", ()=>editLabel(obj.id));
    return d;
  }
  function renderList() {
    labelsList.innerHTML="";
    if(labels.length===0){labelsList.textContent="Nincsenek feliratok."; return;}
    labels.forEach(l=>{
      const row=document.createElement("div"); row.className="item";
      const meta=document.createElement("div"); meta.className="meta"; meta.textContent=l.value+" → "+l.text;
      const controls=document.createElement("div");
      const editB=document.createElement("button"); editB.className="edit"; editB.textContent="Szerkeszt";
      editB.onclick=()=>editLabel(l.id);
      const delB=document.createElement("button"); delB.className="del"; delB.textContent="Töröl";
      delB.onclick=()=>removeLabel(l.id);
      controls.append(editB,delB); row.append(meta,controls); labelsList.appendChild(row);
    });
  }
  function renderLabels() {
    meter.querySelectorAll(".label").forEach(n=>n.remove());
    labels.forEach(l=>{
      const dom=createLabelDom(l); meter.appendChild(dom);
      const pos=computePosForValue(l.value,l.offset||12);
      dom.style.left=pos.left+"px"; dom.style.top=pos.top+"px";
    });
  }
  async function addLabelFromInputs() {
    const vRaw=valueInput.value, txt=textInput.value.trim();
    if(!txt){alert("Adj meg szöveget!");return;}
    const v=Math.round(Number(vRaw));
    if(!isFinite(v)||v<1||v>100){alert("Adj meg 1-100 közötti számot!");return;}
    const docRef=await addDoc(colRef,{value:v,text:txt,offset:12});
    labels.push({id:docRef.id,value:v,text:txt,offset:12});
    valueInput.value=""; textInput.value="";
    renderList(); renderLabels();
  }
  async function editLabel(id) {
    const idx=labels.findIndex(x=>x.id===id); if(idx===-1)return;
    const cur=labels[idx];
    const newValRaw=prompt("Érték (1-100):",cur.value); if(newValRaw===null)return;
    const newVal=Math.round(Number(newValRaw));
    if(!isFinite(newVal)||newVal<1||newVal>100){alert("Hibás szám!");return;}
    const newTxt=prompt("Felirat szövege:",cur.text); if(newTxt===null)return;
    await updateDoc(doc(db,"labels",id),{value:newVal,text:newTxt.trim()||cur.text});
    cur.value=newVal; cur.text=newTxt.trim()||cur.text;
    renderList(); renderLabels();
  }
  async function removeLabel(id) {
    if(!confirm("Biztos törlöd?"))return;
    await deleteDoc(doc(db,"labels",id));
    labels=labels.filter(x=>x.id!==id);
    renderList(); renderLabels();
  }
  async function loadLabels() {
    const snap=await getDocs(colRef);
    labels=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderList(); renderLabels();
  }

  addBtn.onclick=addLabelFromInputs;
  clearBtn.onclick=async()=>{
    if(!confirm("Minden törlése?"))return;
    for(const l of labels){await deleteDoc(doc(db,"labels",l.id));}
    labels=[]; renderList(); renderLabels();
  };
  window.onresize=()=>renderLabels();
  meter.ondblclick=()=>valueInput.focus();
  loadLabels();
</script>
</body>
</html>
